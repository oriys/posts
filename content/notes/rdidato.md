---
title: "数据库索引设计与优化摘录"
date: 2021-02-20T22:46:54+08:00
draft: true
---

## 概述

- 不合适的索引
  - 没有索引足够多的列来支持 where 子句的所有谓词
  - 表上没有足够的索引
  - 一些 select 子句可能没有有效的索引
  - 索引包含了正确的列，但是列的顺序不对
- 误区与误解
  - 索引层级不要超过 5 层
    - 现代存储器有能力把索引的大多数层级保留在数据库缓冲池中
  - 单表的索引数不要超过 6 个
    - 需要做性能测试
    - 保证所有 SQL 语句都能流程运行式设计的底线，如果做到这一点需要创建 10 个索引，那就应该在表上建立 10 个索引。
  - 不应该索引不稳定的列
    - 古时候，更新一个四级索引，至少需要 6 次磁盘读写
    - 现在非子叶都在内存中，只需要 2 次磁盘读写
- 索引设计的观点
  - 找到由于索引不合适而导致运行太慢的查询语句作为最差输入
  - 设计索引，使所有查询语句都运行得足够快，CURD 都需要足够快

## 表和索引结构

- 索引页和表页
  - 一般大小为 4KB
  - 一次 I/O 会读取多个页到缓冲池中
- 索引行
  - 主键索引中，一个索引行等同于叶子页中的一个索引条目
  - 非唯一索引，维护一个索引项，表现为一个值后面带着多个指针
- 索引结构
  - 非叶子页包含一个键值，以及指向下一层级页数的指针
  - B 树索引，访问任何一条记录都需要访问相同数量的非叶子页
- 表行
  - 每一个索引行都指向表中相对应的一行记录
  - 每一行还存储了控制信息
  - 表中记录的顺序可以按照某一个索引的顺序来组织
- 缓冲池和磁盘 I/O
  - 缓冲池管理器将尽力确保经常使用的数据被保存在池中
  - DBMS 缓冲池 > 磁盘缓冲区 > 磁盘
- 从磁盘驱动器进行的顺序读取
  - 每次请求的页数量由 DBMS 决定，只有不在缓冲池的页需要被读取
  - 同时读取多个页意味着平均读取每个页的时间会减少
  - DBMS 预读磁盘页
- 辅助式随机读
  - 自动跳跃式顺序读
    - 如果一系列不连续的行被按照同一方向扫描，那么访问顺序是跳跃式顺序的
    - 聚簇索引访问模式为跳跃式顺序
  - 列表预读
    - 访问所有满足条件的索引行，按照表页的顺序对其进行排序后再访问表行
  - 数据块预读
    - 当表行和索引行的访问顺序不一致时，Oracle 会采取这一特性
    - DBMS 先从索引片收集指针，在进行多重随机 I/O 来并行读取表行
- 辅助式顺序读
  - 顺序扫描一张大表时，优化器开启并行机制，分出多个范围谓词限定的游标并发读取。
- 同步 I/O 与异步 I/O
  - 同步 I/O，在 I/O 操作时，DBMS 不能继续进行其他操作。
  - 异步 I/O，cpu 还在处理前一步的页时，已经开始了下一次 I/O
  - 当 DBMS 请求一个页时，磁盘系统会预读与它相邻的页，这种机制称为磁盘前读
- 硬件特性
  - 磁盘转数 10000r/min ~ 15000r/min
  - 平均寻道时间 3ms
  - RAID 提供了并行读取的能力
- DBMS 特性
  - 页
    - 表页的大小限制了表行的最大长度
    - 如果索引行的长度大于叶子页的 20%，可能会造成糟糕的空间利用率和频繁的叶子页分列
    - 2KB，4KB，8KB 大小的页的随机读取时间大致是相等的
    - 读取一次会加载多个页
    - 不同的 DBMS 支持不同的页大小
  - 表聚簇
    - Oracle 提供的在一张表中交错存储多个相关表的数据的功能
  - 索引行
    - DBMS 所能支持的列的数量上线
    - 列中存在可变长度列时按照最长长度计算
    - 索引键由所有被复制到索引上的列组成，它决定了索引条目的顺序
  - 表行
    - 聚簇索引的顺序与表行的顺序一致
    - 如果没有聚簇索引，新增列会在最后或者任意有空位的页上
  - 索引组织表
    - 将表上所有的列复制到索引的子叶上
    - 包含表行的索引被称为主键索引
    - 节省磁盘空间，CURD 也更快，减少了磁盘读取次数
    - 表上的分列导致其他索引的更新
  - 页邻接
    - 逻辑上的页在物理上相邻
- B 树索引的替代品
  - 位图索引
    - 针对各个不同列值的位图组成
    - 复杂且不可预测的组合谓词的大表查询
    - 位图索引适合静态数据，而不适合索引频繁更新的列
    - 场景
      - 可能的谓词组合数量太多了
      - 单个谓词具有很高的过滤因子
      - 更新操作批量进行
  - 散列
    - 点那个存储一行数据时，表页有一个随机数选择的，该选择器将主键转换为 1 至 N 中间的某个页号，如果该页已满，则将该页放入另一个串联至该页的页中
- 聚簇的许多含义
  - 索引行的顺序和表行的顺序是强关联的
  - 一张表只能有一个聚簇索引，但是可以有多个索引是聚簇的
